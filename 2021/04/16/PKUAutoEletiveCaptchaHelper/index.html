<!DOCTYPE html>


<html lang="en">


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    利用TensorFlow实现的选课网验证码自动识别AI |  tetrahedron&#39;s Hexo
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

<link rel="alternate" href="/atom.xml" title="tetrahedron's Hexo" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-PKUAutoEletiveCaptchaHelper"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  利用TensorFlow实现的选课网验证码自动识别AI
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/2021/04/16/PKUAutoEletiveCaptchaHelper/" class="article-date">
  <time datetime="2021-04-16T14:12:36.000Z" itemprop="datePublished">2021-04-16</time>
</a>   
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">5.7k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">27 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>前几个星期受朋友的委托，开发了一款针对某大学选课网的验证码识别工具。朋友做的是补退选阶段自动选课部分，而我负责了其中的验证码识别模块。先说一说达到的效果吧，这款工具针对选课网验证码测试集识别率可以达到99.62%，单次识别耗时约0.03秒，实际运行准确率得等到下次选课才知道了，预计不会低于98%。部署在本地可以达到本校学生开发的自动选课工具的平均速度，识别准确度和速度均超越了调用商用验证码识别API。</p>
<a id="more"></a>
<h2 id="图片分析"><a href="#图片分析" class="headerlink" title="图片分析"></a>图片分析</h2><p>没过几天，我就收到了这样一大包带有标签的验证码图片：</p>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/2021/04/16/PKUAutoEletiveCaptchaHelper/g8gs_1615517901796011.png">
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">g8gs_1615517901796011.png</div>
    <br>
</center>

<p>样本总数是19490个，全部爬取自北京大学选课网，并且在打码平台打好了标签。经过简单的观察和分析，我们可以归纳出验证码的以下几个特征：</p>
<ol>
<li>图片分别率为130*52，png格式。</li>
<li>图片只有一个通道，也就是说这张看起来是彩色的图像实际上是灰度图。</li>
<li>图片名前四个字字符即为对应的标签。</li>
<li>图片存在随机添加的噪点和线条，遮挡关系中均位于底层，因此对识别的影响程度不大。</li>
<li>字符有两种表现形式，一种是实心字符，另一种是空心的边框，对识别影响程度未知。</li>
<li>字符与字符间、字符与图片边界间可能存在遮挡关系，对识别影响程度较大。</li>
<li>验证码字符集是字母和数字的子集，具体来说不包含“0，1，i，j，o，z”这6个字符。</li>
<li>验证码不区分大小写，但图片中字符包含大小写。</li>
<li>同一验证码可能出现重复字符。</li>
<li>标签并非完全准确，后期统计估算的结果是，标签整体准确率约为90%。</li>
</ol>
<p>综合以上几点，我们需要做的是输入一张图片，输出一个字符串，这个字符串即为对该图片的识别结果。很显然这是一个多分类问题，分类总数是$30^4=8.1\times 10^5$。对于这个数量级的多分类问题，我对人工智能能否胜任还打了个问号。毕竟随机一个结果，正确的概率约等于中头奖。面向CSDN编程当然能查出不少别人的成功样例，但是别人的代码和我们目前的需求依然存在不小的差异。我也只能以一点点可怜的tensorflow基础开始写代码。</p>
<h2 id="图像预处理"><a href="#图像预处理" class="headerlink" title="图像预处理"></a>图像预处理</h2><p>tensorflow只能接受张量输入，因此我们首先要做的是把读取的图像转换成tensor类型。与此同时，我们还要从图片名中截出标签字段，转换成tensor一起送入神经网络训练。先把字母表写好：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alphabet = [<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;k&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>读入的标签也不能直接喂给模型，需要先转换成独热码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">text2vec</span>(<span class="params">text</span>):</span></span><br><span class="line">    vector = np.zeros([<span class="number">4</span>, <span class="number">30</span>])</span><br><span class="line">    <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(text):</span><br><span class="line">        idx = alphabet.index(c)</span><br><span class="line">        vector[i][idx] = <span class="number">1.0</span></span><br><span class="line">    <span class="keyword">return</span> vector</span><br></pre></td></tr></table></figure>
<p>在开始我们的工作前，我们还要把一大包图片分成训练集和测试集（当然keras也支持自动分割），我按照80%：20%的比例划分训练集和测试集。训练集中的损失函数值在反向传播时会更新所有的可训练参数，而测试集仅仅计算损失函数值，相当于预测。训练集和测试集不能有交集，否则达不到训练目的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">path=<span class="string">r&#x27;./img/&#x27;</span></span><br><span class="line">imglist=os.listdir(path)</span><br><span class="line">random.shuffle(imglist)</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;./img.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> imglist:</span><br><span class="line">    f.write(i+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">f.close()</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;./img_test.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> imglist[:<span class="built_in">len</span>(imglist)//<span class="number">5</span>]:</span><br><span class="line">    f.write(i+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">f.close()</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;./img_train.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> imglist[<span class="built_in">len</span>(imglist)//<span class="number">5</span>:]:</span><br><span class="line">    f.write(i+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>有了这些字母表和函数，我们就可以愉快地往下写读文件的函数了。为了比较模型的稳定性，每次训练我都会随机划分训练集和测试集。我们把图片转换成numpy数组格式并进行归一化，tensorflow可直接读取numpy数组并转换成张量。归一化非常重要，否则你会看到模型loss函数和所有可训练参数直接飞升，通通显示NaN。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generateds</span>(<span class="params">path, txt</span>):</span></span><br><span class="line">    f = <span class="built_in">open</span>(txt, <span class="string">&#x27;r&#x27;</span>)  </span><br><span class="line">    contents = f.readlines() </span><br><span class="line">    random.shuffle(contents)</span><br><span class="line">    f.close() </span><br><span class="line">    x, y_ = [], [] </span><br><span class="line">    <span class="keyword">for</span> content <span class="keyword">in</span> contents:</span><br><span class="line">        value = text2vec(content[:<span class="number">4</span>])</span><br><span class="line">        img_path = path + content </span><br><span class="line">        img = Image.<span class="built_in">open</span>(img_path[:-<span class="number">1</span>])</span><br><span class="line">        img = np.array(img) </span><br><span class="line">        img = img / <span class="number">255.</span></span><br><span class="line">        x.append(img) </span><br><span class="line">        y_.append(value)</span><br><span class="line">    x = np.array(x)</span><br><span class="line">    y_ = np.array(y_)</span><br><span class="line">    x = x.astype(np.float32)</span><br><span class="line">    y_ = y_.astype(np.float32) </span><br><span class="line">    x = np.expand_dims(x, axis=<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> x, y_ </span><br></pre></td></tr></table></figure>
<p>当然，实际的代码过程并没有我在这里展示的如此简单，一个极易被忽略的细节是通道。正常的RGB图有三个维度：宽度、高度和通道数。然而这奇葩的验证码竟然没有通道维！傻乎乎的我直接把tensor喂到模型中，报错显示维度不匹配。这小样竟然只有三个维度(None, 52, 130)，而二维卷积需要四个维度！琢磨了半天，我想直接给你加上通道维行不行，于是给图片张量添加了3号维度。竟然行了！这小家伙可是折磨了我整整一个晚上啊。</p>
<p>另外值得注意的是，二维卷积需求的张量维度分别是batch数、高度、宽度和通道数。碰巧numpy数组也是高度维在前，宽度维在后，如果反过来的话也很容易中招。</p>
<h2 id="利用keras搭建卷积神经网络"><a href="#利用keras搭建卷积神经网络" class="headerlink" title="利用keras搭建卷积神经网络"></a>利用keras搭建卷积神经网络</h2><p>keras已经把tensorflow的方法封装得相当到位了，搭建网络的过程并没有给我造成太大的困难。我先比较了一下常见的CNN代码实现难度，VGGNet算是最好写的，不用写类就能搞得定，而且代码结构也很规整。如果识别水平实在不行，那就再试试别的，比如InceptionNet或是ResNet。</p>
<p>我对VGGNet做了一些调整，在这里卷积神经网络基本结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">Model: &quot;model&quot;</span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">Layer (type)                    Output Shape         Param #     Connected to                     </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">input_1 (InputLayer)            [(None, 52, 130, 1)] 0                                            </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d (Conv2D)                 (None, 52, 130, 32)  320         input_1[0][0]                    </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization (BatchNorma (None, 52, 130, 32)  128         conv2d[0][0]                     </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation (Activation)         (None, 52, 130, 32)  0           batch_normalization[0][0]        </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_1 (Conv2D)               (None, 52, 130, 32)  9248        activation[0][0]                 </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_1 (BatchNor (None, 52, 130, 32)  128         conv2d_1[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_1 (Activation)       (None, 52, 130, 32)  0           batch_normalization_1[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">max_pooling2d (MaxPooling2D)    (None, 26, 65, 32)   0           activation_1[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dropout (Dropout)               (None, 26, 65, 32)   0           max_pooling2d[0][0]              </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_2 (Conv2D)               (None, 26, 65, 64)   18496       dropout[0][0]                    </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_2 (BatchNor (None, 26, 65, 64)   256         conv2d_2[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_2 (Activation)       (None, 26, 65, 64)   0           batch_normalization_2[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_3 (Conv2D)               (None, 26, 65, 64)   36928       activation_2[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_3 (BatchNor (None, 26, 65, 64)   256         conv2d_3[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_3 (Activation)       (None, 26, 65, 64)   0           batch_normalization_3[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">max_pooling2d_1 (MaxPooling2D)  (None, 13, 33, 64)   0           activation_3[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dropout_1 (Dropout)             (None, 13, 33, 64)   0           max_pooling2d_1[0][0]            </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_4 (Conv2D)               (None, 13, 33, 128)  73856       dropout_1[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_4 (BatchNor (None, 13, 33, 128)  512         conv2d_4[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_4 (Activation)       (None, 13, 33, 128)  0           batch_normalization_4[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_5 (Conv2D)               (None, 13, 33, 128)  147584      activation_4[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_5 (BatchNor (None, 13, 33, 128)  512         conv2d_5[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_5 (Activation)       (None, 13, 33, 128)  0           batch_normalization_5[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">max_pooling2d_2 (MaxPooling2D)  (None, 7, 17, 128)   0           activation_5[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dropout_2 (Dropout)             (None, 7, 17, 128)   0           max_pooling2d_2[0][0]            </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_6 (Conv2D)               (None, 7, 17, 256)   295168      dropout_2[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_6 (BatchNor (None, 7, 17, 256)   1024        conv2d_6[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_6 (Activation)       (None, 7, 17, 256)   0           batch_normalization_6[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_7 (Conv2D)               (None, 7, 17, 256)   590080      activation_6[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_7 (BatchNor (None, 7, 17, 256)   1024        conv2d_7[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_7 (Activation)       (None, 7, 17, 256)   0           batch_normalization_7[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">max_pooling2d_3 (MaxPooling2D)  (None, 4, 9, 256)    0           activation_7[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dropout_3 (Dropout)             (None, 4, 9, 256)    0           max_pooling2d_3[0][0]            </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_8 (Conv2D)               (None, 4, 9, 512)    1180160     dropout_3[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_8 (BatchNor (None, 4, 9, 512)    2048        conv2d_8[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_8 (Activation)       (None, 4, 9, 512)    0           batch_normalization_8[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_9 (Conv2D)               (None, 4, 9, 512)    2359808     activation_8[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">batch_normalization_9 (BatchNor (None, 4, 9, 512)    2048        conv2d_9[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">activation_9 (Activation)       (None, 4, 9, 512)    0           batch_normalization_9[0][0]      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">max_pooling2d_4 (MaxPooling2D)  (None, 2, 5, 512)    0           activation_9[0][0]               </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dropout_4 (Dropout)             (None, 2, 5, 512)    0           max_pooling2d_4[0][0]            </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">flatten (Flatten)               (None, 5120)         0           dropout_4[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dense (Dense)                   (None, 4096)         20975616    flatten[0][0]                    </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dropout_5 (Dropout)             (None, 4096)         0           dense[0][0]                      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dense_1 (Dense)                 (None, 4096)         16781312    dropout_5[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dropout_6 (Dropout)             (None, 4096)         0           dense_1[0][0]                    </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dense_2 (Dense)                 (None, 30)           122910      dropout_6[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dense_3 (Dense)                 (None, 30)           122910      dropout_6[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dense_4 (Dense)                 (None, 30)           122910      dropout_6[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dense_5 (Dense)                 (None, 30)           122910      dropout_6[0][0]                  </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">tf.convert_to_tensor (TFOpLambd (4, None, 30)        0           dense_2[0][0]                    </span><br><span class="line">                                                                 dense_3[0][0]                    </span><br><span class="line">                                                                 dense_4[0][0]                    </span><br><span class="line">                                                                 dense_5[0][0]                    </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">tf.compat.v1.transpose (TFOpLam (None, 4, 30)        0           tf.convert_to_tensor[0][0]       </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Total params: 42,968,152</span><br><span class="line">Trainable params: 42,964,184</span><br><span class="line">Non-trainable params: 3,968</span><br><span class="line">__________________________________________________________________________________________________</span><br></pre></td></tr></table></figure>
<p>第一部分是10层卷积。使用3*3的卷积核，卷积核个数从32开始，每两层变成原来的两倍，与此同时深度也会变为原来的两倍。卷积步长为1，使用全零填充。接着进行批标准化操作，使用relu激活函数。每两层我们做一次2*2的最大池化，池化步长为2，使用全零填充。每两层我们舍弃一次，每层舍弃20%的节点以防止模型过拟合。</p>
<p>第二部分是两层4096个节点的全连接，全连接前先把张量拉直成一维，采用relu激活函数。最后一步是连接到输出层，这里我们使用了4个全连接层代表了输出的四个字符，在这里我们使用softmax激活函数使输出符合概率分布。为了匹配最终的输出结果，我们还要调换一下输出张量的维度顺序。</p>
<p>最后的模型代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.keras.models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tensorflow.keras.layers <span class="keyword">import</span> *</span><br><span class="line">input_tensor = Input((<span class="number">52</span>, <span class="number">130</span>, <span class="number">1</span>))</span><br><span class="line">x = input_tensor</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    x = Convolution2D(filters=<span class="number">32</span> * <span class="number">2</span> ** (i // <span class="number">2</span>), kernel_size=<span class="number">3</span>, strides=<span class="number">1</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">    x = BatchNormalization()(x)</span><br><span class="line">    x = Activation(activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">        x = MaxPooling2D(pool_size=<span class="number">2</span>, strides=<span class="number">2</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">        x = Dropout(<span class="number">0.2</span>)(x)</span><br><span class="line">x = Flatten()(x)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    x = Dense(<span class="number">4096</span>, activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">x = tf.convert_to_tensor([Dense(<span class="number">30</span>, activation=<span class="string">&#x27;softmax&#x27;</span>)(x) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)])</span><br><span class="line">x = tf.transpose(x, perm=[<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>])</span><br></pre></td></tr></table></figure>
<h2 id="训练卷积神经网络"><a href="#训练卷积神经网络" class="headerlink" title="训练卷积神经网络"></a>训练卷积神经网络</h2><p>炼丹炉已经造好，原料也已准备完毕，现在终于可以开始“炼丹”了。加载模型，设置好优化器，设置好损失函数和准确度，设置好存档和断点续训，设置好batch大小和epoch，设置好回调函数，喂入数据和标签，现在开始听天由命了，我也不知道这台机器能学成什么鬼样。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.keras.optimizers <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tensorflow.keras.callbacks <span class="keyword">import</span> *</span><br><span class="line">train_path = <span class="string">&#x27;./img/&#x27;</span></span><br><span class="line">train_txt = <span class="string">&#x27;./venv/img_train.txt&#x27;</span></span><br><span class="line">test_path = <span class="string">&#x27;./img/&#x27;</span></span><br><span class="line">test_txt = <span class="string">&#x27;./img_test.txt&#x27;</span></span><br><span class="line">x_train, y_train = generateds(train_path, train_txt)</span><br><span class="line">x_test, y_test = generateds(test_path, test_txt)</span><br><span class="line">model = Model(input_tensor, x)</span><br><span class="line">optimizer = Adadelta(learning_rate=<span class="number">0.8</span>)</span><br><span class="line">reduce_lr = LearningRateScheduler(scheduler)</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;categorical_crossentropy&#x27;</span>,optimizer=optimizer,metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line">checkpoint_save_path = <span class="string">&quot;./captcha.ckpt&quot;</span></span><br><span class="line"><span class="keyword">if</span> os.path.exists(checkpoint_save_path + <span class="string">&#x27;.index&#x27;</span>):</span><br><span class="line">    print(<span class="string">&#x27;-------------load the model-----------------&#x27;</span>)</span><br><span class="line">    model.load_weights(checkpoint_save_path)</span><br><span class="line">cp_callback = ModelCheckpoint(filepath=checkpoint_save_path,save_weights_only=<span class="literal">True</span>, save_best_only=<span class="literal">True</span>)</span><br><span class="line">history = model.fit(x_train, y_train, batch_size=<span class="number">64</span>, epochs=<span class="number">20</span>, validation_data=(x_test, y_test), validation_freq=<span class="number">1</span>,callbacks=[cp_callback, reduce_lr])</span><br><span class="line">model.summary()</span><br></pre></td></tr></table></figure>
<p>训了几个小时，我就发现有点不对劲了。loss函数和准确度几乎没有收敛的意思，仍在瞎蒙附近徘徊。这事就有点诡异了，按理说是会收敛的，难道是我的学习率还不够大？我的学习率是默认的0.01，这么复杂的模型，光是训练一轮就要40s，如果调大学习率恐怕会出现不收敛的情况。保险起见，我让它以低学习率通宵训练，看看800个epoch后是个什么样。</p>
<p>第二天早上起来，炼丹的结果让我喜出望外。一个晚上的风扇轰鸣没有白费，虽然开始的100个epoch的确是瞎蒙，但后来神经网络似乎找到了门道，准确度开始线性增长。单字符准确度从0.03增加到0.7，现在神经网络已经从人工智障逐步训练成人工智能了，但离应用还天远地远。4个字符组成的验证码准确度是单字符的4次方，也就是$0.7^4=0.2401$，从应用角度来看和完全不能用也没什么区别。也就是说，学到了，但没有完全学到。</p>
<p>接下来要做的事就简单了，我们仅需可劲地提高学习率。当然，高学习率也就导致了模型在短短10个epoch后准确率就达到90%，此后模型迅速出现过拟合现象。为此，我们需要设置指数衰减学习率，也就有了以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.keras.backend <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scheduler</span>(<span class="params">epoch</span>):</span></span><br><span class="line">    <span class="keyword">if</span> epoch % <span class="number">4</span> == <span class="number">0</span> <span class="keyword">and</span> epoch != <span class="number">0</span>:</span><br><span class="line">        lr = get_value(model.optimizer.lr)</span><br><span class="line">        set_value(model.optimizer.lr, lr * <span class="number">0.5</span>)</span><br><span class="line">        print(<span class="string">&quot;lr changed to &#123;&#125;&quot;</span>.<span class="built_in">format</span>(lr * <span class="number">0.5</span>))</span><br><span class="line">    <span class="keyword">return</span> get_value(model.optimizer.lr)</span><br></pre></td></tr></table></figure>
<p>为了直观地显示训练进度，可以使用matplotlib绘制acc曲线。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line">acc = history.history[<span class="string">&#x27;accuracy&#x27;</span>]</span><br><span class="line">val_acc = history.history[<span class="string">&#x27;val_accuracy&#x27;</span>]</span><br><span class="line">acc = [i ** <span class="number">4</span> <span class="keyword">for</span> i <span class="keyword">in</span> acc]</span><br><span class="line">val_acc = [i ** <span class="number">4</span> <span class="keyword">for</span> i <span class="keyword">in</span> val_acc]</span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">plt.plot(acc, label=<span class="string">&#x27;Training Accuracy&#x27;</span>)</span><br><span class="line">plt.plot(val_acc, label=<span class="string">&#x27;Validation Accuracy&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Training and Validation Accuracy&#x27;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<h2 id="优化识别准确率"><a href="#优化识别准确率" class="headerlink" title="优化识别准确率"></a>优化识别准确率</h2><p>在接下来的几个小时里，通过不断调整模型参数，单字符准确度从0.7迅速增加到0.95，训练一次模型的时间也从30分钟缩短到15分钟。然而，$0.95^4\approx0.815$，这依然达不到可应用的水平。现在我可以一个个的看看模型和标签不一样的地方在哪里了。我们先写个译码函数把输出张量转换成字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">y</span>):</span></span><br><span class="line">    y = np.argmax(y, axis=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([alphabet[x] <span class="keyword">for</span> x <span class="keyword">in</span> y])</span><br></pre></td></tr></table></figure>
<p>把所有图片一起喂进去，和标签不一样的全部打印出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">x_ans, y_ans = generateds(train_path, <span class="string">&#x27;./venv/img.txt&#x27;</span>)</span><br><span class="line">y_pred = model.predict(x_ans)</span><br><span class="line">ans = []</span><br><span class="line">pred = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> y_ans:</span><br><span class="line">    ans.append(decode(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> y_pred:</span><br><span class="line">    pred.append(decode(i))</span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ans)):</span><br><span class="line">    <span class="keyword">if</span> ans[i] != pred[i]:</span><br><span class="line">        <span class="keyword">if</span> j % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">            print(j)</span><br><span class="line">        print(ans[i], <span class="string">&#x27;  &#x27;</span>, pred[i])</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">print(j)</span><br></pre></td></tr></table></figure>
<p>好家伙，打印出1500多个！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">sgan    sgam</span><br><span class="line">mam7    mamv</span><br><span class="line">tfsm    tfsn</span><br><span class="line">5mdh    4mdh</span><br><span class="line">d8fr    dbfr</span><br><span class="line">dcsb    d2sb</span><br><span class="line">htvn    htvm</span><br><span class="line">qm46    qh46</span><br><span class="line">cwpa    gwpa</span><br><span class="line">glmf    glmt</span><br><span class="line">wm4e    wmhe</span><br><span class="line">hapl    hbpl</span><br><span class="line">srgk    spgk</span><br><span class="line">mxms    mxm5</span><br><span class="line">bums    bum5</span><br><span class="line">twut    twu7</span><br><span class="line">apvn    apvh</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>点进去一个，一看是标签错了。又点进去一个，又是标签错了……一个个看下来有八成都是标签的错。看来我的神经网络也没有那么不堪嘛。修改标签的这部分工作实在是令人难以忍受，我足足花了几乎两个整天才把1500多个验证码一一人工看过一遍。当然，蛮干是不可能的，最好的办法是一边修改标签一边重新训练模型提高准确度。后来的训练结果如下，仅仅训练20轮准确率就达到99%以上，此时甚至还在欠拟合区。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Epoch 1&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 38s 140ms&#x2F;step - loss: 4.0398 - accuracy: 0.0437 - val_loss: 3.3373 - val_accuracy: 0.0412</span><br><span class="line">Epoch 2&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 31s 128ms&#x2F;step - loss: 3.2931 - accuracy: 0.0583 - val_loss: 3.7456 - val_accuracy: 0.0402</span><br><span class="line">Epoch 3&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 31s 129ms&#x2F;step - loss: 2.9358 - accuracy: 0.1276 - val_loss: 3.1022 - val_accuracy: 0.1287</span><br><span class="line">Epoch 4&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 129ms&#x2F;step - loss: 2.1117 - accuracy: 0.3075 - val_loss: 1.4998 - val_accuracy: 0.4837</span><br><span class="line">Epoch 5&#x2F;20</span><br><span class="line">lr changed to 0.4000000059604645</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.9710 - accuracy: 0.6563 - val_loss: 0.8676 - val_accuracy: 0.7014</span><br><span class="line">Epoch 6&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.5527 - accuracy: 0.8030 - val_loss: 0.2733 - val_accuracy: 0.9088</span><br><span class="line">Epoch 7&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 129ms&#x2F;step - loss: 0.3350 - accuracy: 0.8831 - val_loss: 0.1302 - val_accuracy: 0.9582</span><br><span class="line">Epoch 8&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.2138 - accuracy: 0.9277 - val_loss: 0.1094 - val_accuracy: 0.9643</span><br><span class="line">Epoch 9&#x2F;20</span><br><span class="line">lr changed to 0.20000000298023224</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.1041 - accuracy: 0.9646 - val_loss: 0.0466 - val_accuracy: 0.9863</span><br><span class="line">Epoch 10&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.0779 - accuracy: 0.9747 - val_loss: 0.0421 - val_accuracy: 0.9890</span><br><span class="line">Epoch 11&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.0599 - accuracy: 0.9795 - val_loss: 0.0376 - val_accuracy: 0.9902</span><br><span class="line">Epoch 12&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 129ms&#x2F;step - loss: 0.0532 - accuracy: 0.9824 - val_loss: 0.0319 - val_accuracy: 0.9919</span><br><span class="line">Epoch 13&#x2F;20</span><br><span class="line">lr changed to 0.10000000149011612</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.0376 - accuracy: 0.9876 - val_loss: 0.0323 - val_accuracy: 0.9927</span><br><span class="line">Epoch 14&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.0321 - accuracy: 0.9889 - val_loss: 0.0306 - val_accuracy: 0.9931</span><br><span class="line">Epoch 15&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 130ms&#x2F;step - loss: 0.0283 - accuracy: 0.9905 - val_loss: 0.0271 - val_accuracy: 0.9942</span><br><span class="line">Epoch 16&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 32s 132ms&#x2F;step - loss: 0.0259 - accuracy: 0.9906 - val_loss: 0.0254 - val_accuracy: 0.9947</span><br><span class="line">Epoch 17&#x2F;20</span><br><span class="line">lr changed to 0.05000000074505806</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 35s 145ms&#x2F;step - loss: 0.0221 - accuracy: 0.9922 - val_loss: 0.0235 - val_accuracy: 0.9949</span><br><span class="line">Epoch 18&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 35s 145ms&#x2F;step - loss: 0.0186 - accuracy: 0.9936 - val_loss: 0.0258 - val_accuracy: 0.9944</span><br><span class="line">Epoch 19&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 36s 146ms&#x2F;step - loss: 0.0154 - accuracy: 0.9949 - val_loss: 0.0241 - val_accuracy: 0.9951</span><br><span class="line">Epoch 20&#x2F;20</span><br><span class="line">244&#x2F;244 [&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;] - 35s 145ms&#x2F;step - loss: 0.0197 - accuracy: 0.9933 - val_loss: 0.0234 - val_accuracy: 0.9951</span><br></pre></td></tr></table></figure>
<p>可视化结果如下：</p>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/2021/04/16/PKUAutoEletiveCaptchaHelper/final.png">
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;"></div>
    <br>
</center>

<p>最后一次训练和标签不一致的样本数是75个，准确率达到99.62%。我们随便找个不一样的看看：</p>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/2021/04/16/PKUAutoEletiveCaptchaHelper/glmf_1615512501114772.png">
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    "></div>
    <br>
</center>

<p>AI认为它是“glmf”，还是挺阴间的对吧？</p>
<h2 id="封装识别模块"><a href="#封装识别模块" class="headerlink" title="封装识别模块"></a>封装识别模块</h2><p>至此，我们的炼丹算是全部完成了，最后生成的模型文件有491MB。我们把模型的预测部分单独拎出来，封装成一个识别函数，输入图片路径返回字符串。把加载神经网络的部分封装成另一个函数，在主程序开始时调用以加载神经网络。实测加载神经网络大约需要1秒，每调用一次识别函数大约需要0.03秒。在识别函数处我预留了同时识别多张图片的接口，但目前还看不到有此需求。实际上由于并行计算的特性，一次识别不太多的多张图片所花的时间几乎相同。验证码识别部分的完整代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.keras.models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tensorflow.keras.layers <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在主程序开始时调用此函数加载神经网络</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>():</span></span><br><span class="line">    <span class="comment"># 输入层</span></span><br><span class="line">    x = Input((<span class="number">52</span>, <span class="number">130</span>, <span class="number">1</span>))</span><br><span class="line">    x = input_tensor</span><br><span class="line">    <span class="comment"># 10层卷积，每层批标准化，采用relu激活，每两层进行一次最大池化</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        x = Convolution2D(filters=<span class="number">32</span> * <span class="number">2</span> ** (i // <span class="number">2</span>), kernel_size=<span class="number">3</span>, strides=<span class="number">1</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">        x = BatchNormalization()(x)</span><br><span class="line">        x = Activation(activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            x = MaxPooling2D(pool_size=<span class="number">2</span>, strides=<span class="number">2</span>, padding=<span class="string">&#x27;same&#x27;</span>)(x)</span><br><span class="line">    <span class="comment"># 拉直成一维送入全连接</span></span><br><span class="line">    x = Flatten()(x)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        x = Dense(<span class="number">4096</span>, activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">    <span class="comment"># 输出层</span></span><br><span class="line">    x = tf.convert_to_tensor([Dense(<span class="number">30</span>, activation=<span class="string">&#x27;softmax&#x27;</span>)(x) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)])</span><br><span class="line">    x = tf.transpose(x, perm=[<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>])</span><br><span class="line">    <span class="comment"># 加载神经网络</span></span><br><span class="line">    model = Model(input_tensor, x)</span><br><span class="line">    checkpoint = <span class="string">&quot;./captcha.ckpt&quot;</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(checkpoint + <span class="string">&#x27;.index&#x27;</span>):</span><br><span class="line">        model.load_weights(checkpoint)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 识别验证码，参数为图片路径和模型，返回值为识别结果</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict</span>(<span class="params">path, model</span>):</span></span><br><span class="line">    alphabet = [<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;k&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>]</span><br><span class="line">    <span class="comment"># 读取图片，预处理</span></span><br><span class="line">    x_arr = []</span><br><span class="line">    img = Image.<span class="built_in">open</span>(path)</span><br><span class="line">    img = np.array(img)</span><br><span class="line">    img = img / <span class="number">255.</span></span><br><span class="line">    x_arr.append(img)</span><br><span class="line">    <span class="comment"># 转化为np_array并添加通道维</span></span><br><span class="line">    x_arr = np.array(x_arr)</span><br><span class="line">    x_arr = x_arr.astype(np.float32)</span><br><span class="line">    x_arr = np.expand_dims(x_arr, axis=<span class="number">3</span>)</span><br><span class="line">    <span class="comment"># 识别结果并输出</span></span><br><span class="line">    y_arr = model.predict(x_arr)</span><br><span class="line">    pred = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> y_arr:</span><br><span class="line">        n = np.argmax(i, axis=<span class="number">1</span>)</span><br><span class="line">        pred.append(<span class="string">&#x27;&#x27;</span>.join([alphabet[j] <span class="keyword">for</span> j <span class="keyword">in</span> n]))</span><br><span class="line">    <span class="keyword">return</span> pred[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/2021/04/16/PKUAutoEletiveCaptchaHelper/QRcode.png">
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">扫描二维码阅读原文</div>
    <br>
</center> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
  
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2021
        <i class="ri-heart-fill heart_icon"></i> tetrahedron
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        Powered by <a href="https://hexo.io" target="_blank">Hexo</a>
        <span class="division">|</span>
        Theme - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>Visitors:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>Views:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="tetrahedron&#39;s Hexo"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->


    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">
        <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script>
        
    


<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>


<!-- ClickBoom2 -->

<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>



    
  </div>
</body>

</html>